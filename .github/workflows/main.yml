name: Copy Remote File to Repository

on:
  schedule:
    - cron: '0 22 * * *'  # Âåó‰∫¨Êó∂Èó¥Êó©‰∏ä6ÁÇπ = UTC 22:00
  workflow_dispatch:      # ÂèØÊâãÂä®Ëß¶Âèë
  push:                  # ÂΩì‰ªìÂ∫ìÊúâpushÊó∂‰πüËß¶Âèë
    branches:
      - main

jobs:
  copy-file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Download remote file
        run: |
          REMOTE_URL="https://my9.ltd/tv/pllive.txt"
          LOCAL_PATH="./sej95.github.io/pllive.txt"
          
          echo "ÂºÄÂßã‰∏ãËΩΩÊñá‰ª∂: $REMOTE_URL"
          echo "ÂΩìÂâçÊó∂Èó¥: $(date)"
          
          # ÂàõÂª∫ÁõÆÊ†áÁõÆÂΩïÔºàÂ¶ÇÊûú‰∏çÂ≠òÂú®Ôºâ
          mkdir -p ./sej95.github.io
          
          echo "‰ΩøÁî® wget Â∞ùËØï‰∏ãËΩΩÊñá‰ª∂..."
          
          # ‰ΩøÁî® wget Êõø‰ª£ curlÔºåÊõ¥Á®≥ÂÆö‰∏îÈîôËØØ‰ø°ÊÅØÊõ¥ËØ¶ÁªÜ
          if wget --timeout=30 --tries=3 --no-check-certificate -O "$LOCAL_PATH" "$REMOTE_URL"; then
            echo "‚úÖ Êñá‰ª∂‰∏ãËΩΩÊàêÂäü: $REMOTE_URL"
            echo "Êñá‰ª∂Â∑≤‰øùÂ≠òÂà∞: $LOCAL_PATH"
            
            # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶Â≠òÂú®‰∏îÊúâÂÜÖÂÆπ
            if [ -s "$LOCAL_PATH" ]; then
              FILE_SIZE=$(stat -f%z "$LOCAL_PATH" 2>/dev/null || stat -c%s "$LOCAL_PATH" 2>/dev/null || echo "unknown")
              echo "Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
              
              # ÊòæÁ§∫ÂâçÂá†Ë°åÂÜÖÂÆπÈ¢ÑËßà
              echo "Êñá‰ª∂È¢ÑËßà(Ââç5Ë°å):"
              head -5 "$LOCAL_PATH" 2>/dev/null || echo "Êó†Ê≥ïÊòæÁ§∫Êñá‰ª∂ÂÜÖÂÆπ"
            else
              echo "‚ö†Ô∏è Ë≠¶ÂëäÔºö‰∏ãËΩΩÁöÑÊñá‰ª∂‰∏∫Á©∫Êàñ‰∏çÂ≠òÂú®"
              exit 1
            fi
          else
            echo "‚ùå Êñá‰ª∂‰∏ãËΩΩÂ§±Ë¥•: $REMOTE_URL"
            echo "Ê≠£Âú®Â∞ùËØï‰ΩøÁî® curl..."
            
            # Â∞ùËØï‰ΩøÁî® curl ‰Ωú‰∏∫Â§áÁî®ÊñπÊ°à
            HTTP_STATUS=$(curl -L -o "$LOCAL_PATH" -s -w "%{http_code}" --max-time 30 --retry 2 --insecure "$REMOTE_URL")
            
            if [ "$HTTP_STATUS" -eq 200 ] && [ -s "$LOCAL_PATH" ]; then
              echo "‚úÖ curl‰∏ãËΩΩÊàêÂäü (HTTP $HTTP_STATUS)"
              FILE_SIZE=$(stat -f%z "$LOCAL_PATH" 2>/dev/null || stat -c%s "$LOCAL_PATH" 2>/dev/null || echo "unknown")
              echo "Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
            else
              echo "‚ùå ÊâÄÊúâ‰∏ãËΩΩÂ∞ùËØïÈÉΩÂ§±Ë¥•"
              echo "HTTPÁä∂ÊÄÅÁ†Å: $HTTP_STATUS"
              echo "ÊúÄÂêéÈîôËØØ: curlËøîÂõû‰ª£Á†Å $?"
              
              # Â∞ùËØïÊòæÁ§∫Êõ¥Â§öÈîôËØØ‰ø°ÊÅØ
              curl -L -o /dev/null -v "$REMOTE_URL" 2>&1 | grep -i "error\|fail\|http" | head -10 || true
              
              # Â¶ÇÊûúÁõÆÂΩï‰∏çÂ≠òÂú®ÔºåÂàõÂª∫‰∏Ä‰∏™Á©∫Êñá‰ª∂
              if [ ! -f "$LOCAL_PATH" ]; then
                echo "ÂàõÂª∫Á©∫Êñá‰ª∂Âç†‰Ωç..."
                echo "# Êñá‰ª∂‰∏ãËΩΩÂ§±Ë¥• - $(date)" > "$LOCAL_PATH"
              fi
            fi
          fi
          
      - name: Check if file exists
        run: |
          LOCAL_PATH="./sej95.github.io/pllive.txt"
          if [ -f "$LOCAL_PATH" ]; then
            echo "‚úÖ Êñá‰ª∂Â≠òÂú®: $LOCAL_PATH"
            if [ -s "$LOCAL_PATH" ]; then
              echo "Êñá‰ª∂Â§ßÂ∞è: $(wc -c < "$LOCAL_PATH") Â≠óËäÇ"
              echo "Êñá‰ª∂Ë°åÊï∞: $(wc -l < "$LOCAL_PATH") Ë°å"
            else
              echo "‚ö†Ô∏è Ë≠¶ÂëäÔºöÊñá‰ª∂Â≠òÂú®‰ΩÜ‰∏∫Á©∫"
            fi
          else
            echo "‚ùå ÈîôËØØÔºöÊñá‰ª∂‰∏çÂ≠òÂú®"
            exit 1
          fi
          
      - name: Commit and push if changes
        run: |
          LOCAL_PATH="./sej95.github.io/pllive.txt"
          
          # Á°Æ‰øùÊñá‰ª∂Â≠òÂú®
          if [ ! -f "$LOCAL_PATH" ]; then
            echo "‚ùå ÈîôËØØÔºöÁõÆÊ†áÊñá‰ª∂‰∏çÂ≠òÂú®ÔºåË∑≥ËøáÊèê‰∫§"
            exit 0
          fi
          
          # Ê£ÄÊü•Êñá‰ª∂ÊòØÂê¶ÊúâÂèòÂåñ
          if git diff --quiet "$LOCAL_PATH"; then
            echo "‚ö†Ô∏è Êñá‰ª∂ÂÜÖÂÆπÊó†ÂèòÂåñÔºåÊó†ÈúÄÊèê‰∫§"
          else
            echo "Ê£ÄÊµãÂà∞Êñá‰ª∂ÂèòÂåñÔºåÊèê‰∫§Êõ¥Êñ∞..."
            
            # ÊòæÁ§∫ÂÖ∑‰ΩìÂèòÂåñÔºàÈôêÂà∂Ë°åÊï∞Ôºâ
            echo "Êñá‰ª∂Â∑ÆÂºÇÈ¢ÑËßà:"
            git diff "$LOCAL_PATH" | head -50
            
            # Ê∑ªÂä†Êñá‰ª∂
            git add "$LOCAL_PATH"
            
            # Êèê‰∫§Êõ¥Êîπ
            COMMIT_MSG="üîÑ Ëá™Âä®Êõ¥Êñ∞ pllive.txt - $(date '+%Y-%m-%d %H:%M:%S UTC')"
            git commit -m "$COMMIT_MSG" || echo "Êèê‰∫§Â§±Ë¥•ÊàñÊó†Êõ¥Êîπ"
            
            # Êé®ÈÄÅÂà∞‰ªìÂ∫ì
            git push origin main || echo "Êé®ÈÄÅÂ§±Ë¥•ÔºåÂèØËÉΩÊòØÊùÉÈôêÈóÆÈ¢òÊàñÊó†Êñ∞ÂÜÖÂÆπ"
            
            echo "‚úÖ Êñá‰ª∂Êõ¥Êñ∞ÊµÅÁ®ãÂÆåÊàê"
          fi
          
      - name: Clean up and summary
        run: |
          echo "=== ‰ªªÂä°ÊâßË°åÊëòË¶Å ==="
          echo "ÂÆåÊàêÊó∂Èó¥: $(date)"
          echo "UTCÊó∂Èó¥: $(date -u)"
          echo "Ê∫êURL: https://my9.ltd/tv/pllive.txt"
          echo "Êú¨Âú∞Ë∑ØÂæÑ: ./sej95.github.io/pllive.txt"
          
          if [ -f "./sej95.github.io/pllive.txt" ]; then
            FILE_SIZE=$(wc -c < "./sej95.github.io/pllive.txt" 2>/dev/null || echo "unknown")
            echo "ÊúÄÁªàÊñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
          fi
