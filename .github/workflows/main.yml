permissions:
  contents: write
name: Daily TV Source Update

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
  workflow_dispatch:  # å…è®¸æ‰‹åŠ¨è¿è¡Œ

permissions:
  contents: write  # æˆäºˆå†™å…¥æƒé™

jobs:
  update-tv-source:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # è·å–å®Œæ•´å†å²
        
    - name: Setup Git
      run: |
        git config --global user.name "GitHub Actions Bot"
        git config --global user.email "actions@github.com"
        
    - name: Create directory
      run: |
        mkdir -p sej95.github.io
        echo "ç›®å½•åˆ›å»ºå®Œæˆ"
        
    - name: Download TV source file
      run: |
        echo "å¼€å§‹ä¸‹è½½æ–‡ä»¶..."
        cd sej95.github.io
        
        # ä¸‹è½½æ–‡ä»¶åˆ°å½“å‰ç›®å½•
        curl -s -L -o pllive.txt \
             -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
             -H "Referer: https://my9.ltd/" \
             -H "Accept: text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8" \
             --max-time 45 \
             --retry 2 \
             "https://my9.ltd/tv/pllive.txt"
             
        # éªŒè¯ä¸‹è½½ç»“æœ
        if [ -f "pllive.txt" ]; then
          FILE_SIZE=$(wc -c < "pllive.txt")
          FILE_LINES=$(wc -l < "pllive.txt")
          echo "âœ… ä¸‹è½½æˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
          
          # æ˜¾ç¤ºæ–‡ä»¶å‰å‡ è¡Œ
          echo "æ–‡ä»¶å‰5è¡Œå†…å®¹:"
          head -5 pllive.txt || echo "æ— æ³•æ˜¾ç¤ºå†…å®¹"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºM3Uæ ¼å¼
          if head -1 pllive.txt | grep -q "^#EXTM3U"; then
            echo "âœ… æ˜¯æœ‰æ•ˆçš„M3Uæ ¼å¼æ–‡ä»¶"
            # ç»Ÿè®¡é¢‘é“æ•°
            CHANNEL_COUNT=$(grep -c "^#EXTINF" pllive.txt || echo "0")
            echo "é¢‘é“æ•°é‡: $CHANNEL_COUNT"
          else
            echo "âš ï¸ æ³¨æ„: ä¸æ˜¯æ ‡å‡†M3Uæ ¼å¼"
          fi
        else
          echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥"
          exit 1
        fi
        
    - name: Check for changes
      id: check-changes
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        
        # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦å­˜åœ¨
        if [ ! -f "sej95.github.io/pllive.txt" ]; then
          echo "æ–‡ä»¶ä¸å­˜åœ¨ï¼Œéœ€è¦åˆ›å»º"
          echo "should_commit=true" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # æ£€æŸ¥Gitå†å²ä¸­æ˜¯å¦æœ‰è¿™ä¸ªæ–‡ä»¶
        if git ls-files --error-unmatch "sej95.github.io/pllive.txt" >/dev/null 2>&1; then
          echo "æ–‡ä»¶å·²åœ¨Gitä¸­ï¼Œæ¯”è¾ƒå˜åŒ–..."
          
          # è®¡ç®—æ–°æ—§æ–‡ä»¶çš„å“ˆå¸Œå€¼
          OLD_HASH=$(git hash-object "sej95.github.io/pllive.txt")
          NEW_HASH=$(git hash-object "sej95.github.io/pllive.txt")
          
          if [ "$OLD_HASH" = "$NEW_HASH" ]; then
            echo "æ–‡ä»¶æ— å˜åŒ–"
            echo "should_commit=false" >> $GITHUB_OUTPUT
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
            echo "should_commit=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "è¿™æ˜¯æ–°æ–‡ä»¶"
          echo "should_commit=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push if changed
      if: steps.check-changes.outputs.should_commit == 'true'
      run: |
        echo "æäº¤æ–‡ä»¶åˆ°Git..."
        
        # æ·»åŠ æ–‡ä»¶åˆ°Git
        git add sej95.github.io/pllive.txt
        
        # è·å–æ–‡ä»¶ä¿¡æ¯ç”¨äºæäº¤ä¿¡æ¯
        FILE_SIZE=$(wc -c < "sej95.github.io/pllive.txt")
        FILE_LINES=$(wc -l < "sej95.github.io/pllive.txt")
        
        # åˆ›å»ºæäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ“º æ›´æ–°ç›´æ’­æºæ–‡ä»¶ - $(date '+%Y-%m-%d %H:%M') UTC"
        COMMIT_MSG+=" (${FILE_LINES}è¡Œ, ${FILE_SIZE}å­—èŠ‚)"
        
        # æäº¤
        git commit -m "$COMMIT_MSG"
        
        # æ¨é€
        echo "æ¨é€åˆ°GitHub..."
        git push
        
        echo "âœ… å·²æˆåŠŸæäº¤å’Œæ¨é€"
        
    - name: No changes needed
      if: steps.check-changes.outputs.should_commit == 'false'
      run: |
        echo "âœ… æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æ›´æ–°"
        echo "å½“å‰æ–‡ä»¶ä¿¡æ¯:"
        ls -la sej95.github.io/pllive.txt
        echo "æ–‡ä»¶å¤§å°: $(wc -c < "sej95.github.io/pllive.txt") å­—èŠ‚"
        
    - name: Final verification
      run: |
        echo "=== æœ€ç»ˆéªŒè¯ ==="
        echo "å½“å‰ç›®å½•ç»“æ„:"
        ls -la
        
        echo "ç›®æ ‡ç›®å½•ç»“æ„:"
        ls -la sej95.github.io/ || echo "ç›®å½•ä¸å­˜åœ¨"
        
        if [ -f "sej95.github.io/pllive.txt" ]; then
          echo "âœ… æ–‡ä»¶å·²æˆåŠŸä¿å­˜"
          echo "æ–‡ä»¶è·¯å¾„: sej95.github.io/pllive.txt"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < "sej95.github.io/pllive.txt") å­—èŠ‚"
          echo "æ–‡ä»¶MD5: $(md5sum sej95.github.io/pllive.txt | cut -d' ' -f1)"
        else
          echo "âŒ é”™è¯¯: æ–‡ä»¶æœªæ‰¾åˆ°"
        fi
        
        echo "GitçŠ¶æ€:"
        git status --porcelain || echo "æ— æ³•è·å–GitçŠ¶æ€"
