name: Update TV Source File

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p sej95.github.io
        echo "å‡†å¤‡ä¸‹è½½ç›®å½•..."
        
    - name: Download TV source with optimized settings
      id: download
      run: |
        echo "å¼€å§‹ä¸‹è½½ç›´æ’­æºæ–‡ä»¶..."
        
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        LOCAL_PATH="sej95.github.io/pllive.txt"
        TEMP_FILE="pllive_temp.txt"
        
        echo "ç›®æ ‡URL: $REMOTE_URL"
        
        # æ–¹æ³•1: ä½¿ç”¨ç®€å•çš„curlå‘½ä»¤ï¼ˆæ¨¡ä»¿ä½ çš„æœ¬åœ°æµ‹è¯•ï¼‰
        echo "=== æ–¹æ³•1: ç®€å•curlä¸‹è½½ ==="
        curl -s -L \
          -o "$TEMP_FILE" \
          -H "User-Agent: curl/8.8.0" \
          -H "Accept: */*" \
          --max-time 60 \
          "$REMOTE_URL"
          
        DOWNLOAD_RESULT=$?
        
        if [ $DOWNLOAD_RESULT -eq 0 ] && [ -f "$TEMP_FILE" ] && [ -s "$TEMP_FILE" ]; then
          FILE_SIZE=$(wc -c < "$TEMP_FILE")
          echo "âœ… æ–¹æ³•1ä¸‹è½½æˆåŠŸ"
          echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
          
          # æ£€æŸ¥æ–‡ä»¶å†…å®¹æ˜¯å¦æœ‰æ•ˆï¼ˆä¸æ˜¯é”™è¯¯é¡µé¢ï¼‰
          if head -1 "$TEMP_FILE" | grep -q "MoMoæ›´æ–°\|#genre#\|#EXTM3U\|ä¸Šæµ·ç”µä¿¡"; then
            echo "âœ… æ–‡ä»¶å†…å®¹éªŒè¯é€šè¿‡"
            mv "$TEMP_FILE" "$LOCAL_PATH"
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "method=simple_curl" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ–‡ä»¶å†…å®¹æ— æ•ˆ"
            rm -f "$TEMP_FILE"
          fi
        else
          echo "âŒ æ–¹æ³•1å¤±è´¥ï¼Œé”™è¯¯ä»£ç : $DOWNLOAD_RESULT"
          rm -f "$TEMP_FILE"
        fi
        
        # æ–¹æ³•2: å¦‚æœæ–¹æ³•1å¤±è´¥ï¼Œå°è¯•ä½¿ç”¨wget
        if [ ! -f "$LOCAL_PATH" ] || [ ! -s "$LOCAL_PATH" ]; then
          echo ""
          echo "=== æ–¹æ³•2: ä½¿ç”¨wgetä¸‹è½½ ==="
          wget \
            --timeout=45 \
            --tries=3 \
            --user-agent="Mozilla/5.0" \
            --no-check-certificate \
            -O "$LOCAL_PATH" \
            "$REMOTE_URL"
            
          if [ $? -eq 0 ] && [ -s "$LOCAL_PATH" ]; then
            FILE_SIZE=$(wc -c < "$LOCAL_PATH")
            echo "âœ… wgetä¸‹è½½æˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "method=wget" >> $GITHUB_OUTPUT
          else
            echo "âŒ wgetä¹Ÿå¤±è´¥"
            rm -f "$LOCAL_PATH"
          fi
        fi
        
        # æ–¹æ³•3: å¦‚æœè¿˜å¤±è´¥ï¼Œä½¿ç”¨å¸¦æ›´å¤šå‚æ•°çš„curl
        if [ ! -f "$LOCAL_PATH" ] || [ ! -s "$LOCAL_PATH" ]; then
          echo ""
          echo "=== æ–¹æ³•3: è¯¦ç»†curlä¸‹è½½ ==="
          curl -v -L \
            -o "$LOCAL_PATH" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: text/plain,*/*;q=0.9" \
            -H "Accept-Language: zh-CN,zh;q=0.9" \
            -H "Referer: https://my9.ltd/" \
            -H "Connection: keep-alive" \
            -H "Cache-Control: max-age=0" \
            --max-time 90 \
            --retry 3 \
            --retry-delay 2 \
            --compressed \
            "$REMOTE_URL" 2>&1 | tail -20
            
          if [ $? -eq 0 ] && [ -s "$LOCAL_PATH" ]; then
            FILE_SIZE=$(wc -c < "$LOCAL_PATH")
            echo "âœ… è¯¦ç»†curlä¸‹è½½æˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "method=detailed_curl" >> $GITHUB_OUTPUT
          else
            echo "âŒ æ‰€æœ‰ä¸‹è½½æ–¹æ³•éƒ½å¤±è´¥"
            
            # å¦‚æœæœ‰æ—§æ–‡ä»¶ï¼Œä½¿ç”¨å®ƒ
            if [ -f "sej95.github.io/pllive.txt" ] && [ -s "sej95.github.io/pllive.txt" ]; then
              echo "âš ï¸ ä½¿ç”¨ç°æœ‰æ–‡ä»¶"
              echo "downloaded=true" >> $GITHUB_OUTPUT
              echo "method=existing" >> $GITHUB_OUTPUT
            else
              echo "downloaded=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
        fi
        
        # æœ€ç»ˆéªŒè¯
        if [ -f "$LOCAL_PATH" ] && [ -s "$LOCAL_PATH" ]; then
          FINAL_SIZE=$(wc -c < "$LOCAL_PATH")
          FINAL_LINES=$(wc -l < "$LOCAL_PATH")
          
          echo ""
          echo "=== ä¸‹è½½å®Œæˆ ==="
          echo "ä½¿ç”¨æ–¹æ³•: ${{ steps.download.outputs.method }}"
          echo "æœ€ç»ˆæ–‡ä»¶å¤§å°: $FINAL_SIZE å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $FINAL_LINES è¡Œ"
          
          # æ˜¾ç¤ºæ–‡ä»¶å¤´ä¿¡æ¯
          echo "æ–‡ä»¶å¼€å¤´å†…å®¹:"
          head -5 "$LOCAL_PATH"
        fi
        
    - name: Check if file changed
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜åŒ–..."
        
        FILE_PATH="sej95.github.io/pllive.txt"
        
        # ç¡®ä¿æ–‡ä»¶å­˜åœ¨
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨"
          echo "has_change=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        # ç®€å•æ¯”è¾ƒï¼šæ£€æŸ¥æ–‡ä»¶å¤§å°å’Œå†…å®¹
        if [ -f "$FILE_PATH" ]; then
          CURRENT_HASH=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
          echo "å½“å‰æ–‡ä»¶MD5: $CURRENT_HASH"
          
          # æ£€æŸ¥Gitæ˜¯å¦è·Ÿè¸ªæ­¤æ–‡ä»¶
          if git ls-files "$FILE_PATH" >/dev/null 2>&1; then
            # è·å–Gitä¸­çš„æ–‡ä»¶å†…å®¹
            GIT_HASH=$(git hash-object "$FILE_PATH")
            echo "Gitä¸­æ–‡ä»¶å“ˆå¸Œ: $GIT_HASH"
            
            if [ "$CURRENT_HASH" = "$GIT_HASH" ]; then
              echo "æ–‡ä»¶æ— å˜åŒ–"
              echo "has_change=false" >> $GITHUB_OUTPUT
            else
              echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
              echo "has_change=true" >> $GITHUB_OUTPUT
            fi
          else
            echo "æ–‡ä»¶æœªè¢«Gitè·Ÿè¸ªï¼Œæ˜¯æ–°æ–‡ä»¶"
            echo "has_change=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "has_change=false" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ–‡ä»¶..."
        
        FILE_PATH="sej95.github.io/pllive.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "âŒ æ–‡ä»¶ä¸å­˜åœ¨ï¼Œæ— æ³•æäº¤"
          exit 1
        fi
        
        # è·å–æ–‡ä»¶è¯¦ç»†ä¿¡æ¯
        FILE_SIZE=$(wc -c < "$FILE_PATH")
        FILE_LINES=$(wc -l < "$FILE_PATH")
        FILE_MD5=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
        
        echo "=== æäº¤ä¿¡æ¯ ==="
        echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
        echo "æ–‡ä»¶è¡Œæ•°: $FILE_LINES è¡Œ"
        echo "æ–‡ä»¶MD5: $FILE_MD5"
        
        # æ·»åŠ å¹¶æäº¤æ–‡ä»¶
        git add "$FILE_PATH"
        
        # åˆ›å»ºæäº¤ä¿¡æ¯
        COMMIT_MSG="ğŸ“º æ›´æ–°ç›´æ’­æºæ–‡ä»¶ - $(date '+%Y-%m-%d %H:%M UTC')

æ–‡ä»¶ç»Ÿè®¡:
- å¤§å°: ${FILE_SIZE} å­—èŠ‚
- è¡Œæ•°: ${FILE_LINES} è¡Œ
- MD5: ${FILE_MD5}

ä¸‹è½½æ–¹æ³•: ${{ steps.download.outputs.method }}"
        
        echo -e "$COMMIT_MSG" | git commit -F -
        
        # æ¨é€åˆ°ä»“åº“
        echo "æ¨é€åˆ°GitHub..."
        git push
        
        echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆ"
        
    - name: Show final status
      run: |
        echo "=========================================="
        echo "          ä»»åŠ¡æ‰§è¡Œå®Œæˆ"
        echo "=========================================="
        
        echo "æ‰§è¡Œæ—¶é—´: $(date)"
        echo "UTCæ—¶é—´: $(date -u)"
        
        if [ -f "sej95.github.io/pllive.txt" ]; then
          echo ""
          echo "âœ… æ–‡ä»¶çŠ¶æ€:"
          ls -lh "sej95.github.io/pllive.txt"
          
          echo ""
          echo "ğŸ“Š æ–‡ä»¶ç»Ÿè®¡:"
          echo "å¤§å°: $(wc -c < "sej95.github.io/pllive.txt") å­—èŠ‚"
          echo "è¡Œæ•°: $(wc -l < "sej95.github.io/pllive.txt") è¡Œ"
          
          echo ""
          echo "ğŸ“ å†…å®¹é¢„è§ˆ (å‰3è¡Œ):"
          head -3 "sej95.github.io/pllive.txt"
          
          echo ""
          echo "ğŸ” ç›´æ’­æºç»Ÿè®¡:"
          echo "åˆ†ç±»æ•°é‡: $(grep -c "^[^#].*,#genre#" "sej95.github.io/pllive.txt" 2>/dev/null || echo "0")"
          echo "é¢‘é“æ€»æ•°: $(grep -c "^\S.*,http" "sej95.github.io/pllive.txt" 2>/dev/null || echo "0")"
        else
          echo ""
          echo "âŒ é”™è¯¯: æ–‡ä»¶æœªæ‰¾åˆ°"
        fi
        
        echo ""
        echo "ğŸ“‚ ä»“åº“çŠ¶æ€:"
        git status --short
        
        echo ""
        echo "â° ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œ: æ¯å¤© UTC 22:00 (åŒ—äº¬æ—¶é—´ 06:00)"
