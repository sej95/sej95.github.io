name: Copy Remote File to Repository

on:
  schedule:
    - cron: '0 22 * * *'  # åŒ—äº¬æ—¶é—´æ—©ä¸Š6ç‚¹ = UTC 22:00
  workflow_dispatch:      # å¯æ‰‹åŠ¨è§¦å‘
  push:                  # å½“ä»“åº“æœ‰pushæ—¶ä¹Ÿè§¦å‘
    branches:
      - main

jobs:
  copy-file:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Set up Git
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"
          
      - name: Download remote file
        run: |
          REMOTE_URL="https://my9.ltd/tv/pllive.txt"
          LOCAL_PATH="./sej95.github.io/pllive.txt"
          
          echo "å¼€å§‹ä¸‹è½½æ–‡ä»¶: $REMOTE_URL"
          echo "å½“å‰æ—¶é—´: $(date)"
          
          # åˆ›å»ºç›®æ ‡ç›®å½•ï¼ˆå¦‚æœä¸å­˜åœ¨ï¼‰
          mkdir -p ./sej95.github.io
          
          # ä½¿ç”¨ curl ä¸‹è½½æ–‡ä»¶ï¼Œæ·»åŠ è¶…æ—¶å’Œé‡è¯•æœºåˆ¶
          HTTP_STATUS=$(curl -f -L -o "$LOCAL_PATH" -s -w "%{http_code}" --max-time 30 --retry 2 "$REMOTE_URL")
          
          if [ "$HTTP_STATUS" -eq 200 ]; then
            echo "âœ… æ–‡ä»¶ä¸‹è½½æˆåŠŸ: $REMOTE_URL"
            echo "æ–‡ä»¶å·²ä¿å­˜åˆ°: $LOCAL_PATH"
            
            # æ£€æŸ¥æ–‡ä»¶å†…å®¹
            FILE_SIZE=$(stat -f%z "$LOCAL_PATH" 2>/dev/null || stat -c%s "$LOCAL_PATH" 2>/dev/null || echo "unknown")
            echo "æ–‡ä»¶å¤§å°: $FILE_SIZE å­—èŠ‚"
            
            # æ˜¾ç¤ºå‰å‡ è¡Œå†…å®¹é¢„è§ˆ
            echo "æ–‡ä»¶é¢„è§ˆ(å‰5è¡Œ):"
            head -5 "$LOCAL_PATH"
          else
            echo "âŒ æ–‡ä»¶ä¸‹è½½å¤±è´¥: $REMOTE_URL (HTTP $HTTP_STATUS)"
            exit 1
          fi
          
      - name: Commit and push if changes
        run: |
          # æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–
          if git diff --quiet ./sej95.github.io/pllive.txt; then
            echo "âš ï¸ æ–‡ä»¶å†…å®¹æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
          else
            echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–ï¼Œæäº¤æ›´æ–°..."
            
            # æ˜¾ç¤ºå…·ä½“å˜åŒ–
            echo "æ–‡ä»¶å·®å¼‚:"
            git diff ./sej95.github.io/pllive.txt
            
            # æ·»åŠ æ–‡ä»¶
            git add ./sej95.github.io/pllive.txt
            
            # æäº¤æ›´æ”¹
            git commit -m "ğŸ”„ è‡ªåŠ¨æ›´æ–° pllive.txt - $(date '+%Y-%m-%d %H:%M:%S') [åŒ—äº¬æ—¶é—´]"
            
            # æ¨é€åˆ°ä»“åº“
            git push origin main
            
            echo "âœ… æ–‡ä»¶å·²æäº¤å¹¶æ¨é€"
          fi
          
      - name: Clean up
        run: |
          echo "ä»»åŠ¡æ‰§è¡Œå®Œæˆæ—¶é—´: $(date)"
          echo "å½“å‰UTCæ—¶é—´: $(date -u)"
          echo "ä»»åŠ¡æ‰§è¡Œè¯¦æƒ…:"
          echo "- è§¦å‘æ—¶é—´: æ¯å¤©åŒ—äº¬æ—¶é—´ 6:00 (UTC 22:00)"
          echo "- æºæ–‡ä»¶: https://my9.ltd/tv/pllive.txt"
          echo "- ç›®æ ‡ä½ç½®: /sej95.github.io/pllive.txt"
