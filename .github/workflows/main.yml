name: Update TV Source File

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = åŒ—äº¬æ—¶é—´ 06:00
  workflow_dispatch:

permissions:
  contents: write  # æˆäºˆå†™å…¥ä»“åº“çš„æƒé™

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository with write permission
      uses: actions/checkout@v4
      with:
        # ä½¿ç”¨é»˜è®¤çš„GITHUB_TOKENï¼Œä¸Šé¢å·²ç»æˆäºˆäº†writeæƒé™
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Setup Git identity
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Create directory structure
      run: |
        echo "åˆ›å»ºç›®å½•ç»“æ„..."
        mkdir -p sej95.github.io
        
    - name: Download TV source file
      id: download
      run: |
        echo "æ­£åœ¨ä¸‹è½½ç›´æ’­æºæ–‡ä»¶..."
        echo "URL: https://my9.ltd/tv/pllive.txt"
        
        # ä¸‹è½½æ–‡ä»¶
        curl -s -L -o "sej95.github.io/pllive.txt" \
          -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
          -H "Accept: text/plain,text/html" \
          -H "Referer: https://my9.ltd/" \
          --connect-timeout 30 \
          --max-time 60 \
          --retry 2 \
          "https://my9.ltd/tv/pllive.txt"
        
        # éªŒè¯ä¸‹è½½ç»“æœ
        if [ $? -eq 0 ] && [ -f "sej95.github.io/pllive.txt" ]; then
          FILE_SIZE=$(wc -c < "sej95.github.io/pllive.txt")
          if [ $FILE_SIZE -gt 0 ]; then
            echo "âœ… ä¸‹è½½æˆåŠŸ"
            echo "æ–‡ä»¶å¤§å°: ${FILE_SIZE} å­—èŠ‚"
            echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < "sej95.github.io/pllive.txt") è¡Œ"
            
            # è¾“å‡ºåˆ°æ­¥éª¤ç»“æœ
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "file_size=${FILE_SIZE}" >> $GITHUB_OUTPUT
          else
            echo "âŒ ä¸‹è½½çš„æ–‡ä»¶ä¸ºç©º"
            echo "downloaded=false" >> $GITHUB_OUTPUT
          fi
        else
          echo "âŒ ä¸‹è½½å¤±è´¥"
          echo "downloaded=false" >> $GITHUB_OUTPUT
          exit 1
        fi
        
    - name: Check for file changes
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶æ˜¯å¦æœ‰å˜åŒ–..."
        
        # å…ˆæ·»åŠ æ‰€æœ‰æ›´æ”¹åˆ°æš‚å­˜åŒºï¼Œä»¥ä¾¿git diffèƒ½æ­£ç¡®æ¯”è¾ƒ
        git add -N "sej95.github.io/pllive.txt"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æœªæš‚å­˜çš„æ›´æ”¹
        if git diff --quiet -- "sej95.github.io/pllive.txt" 2>/dev/null; then
          echo "æ–‡ä»¶å†…å®¹æ— å˜åŒ–"
          echo "has_change=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜åŒ–"
          echo "has_change=true" >> $GITHUB_OUTPUT
          
          # æ˜¾ç¤ºç®€è¦å˜åŒ–ä¿¡æ¯
          echo "å˜åŒ–æ‘˜è¦:"
          git diff --stat -- "sej95.github.io/pllive.txt"
        fi
        
    - name: Commit and push if changed
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ›´æ”¹..."
        
        # è·å–è¯¦ç»†çš„æ–‡ä»¶ä¿¡æ¯
        FILE_PATH="sej95.github.io/pllive.txt"
        FILE_SIZE=$(wc -c < "$FILE_PATH")
        FILE_LINES=$(wc -l < "$FILE_PATH")
        
        echo "æ–‡ä»¶ä¿¡æ¯:"
        echo "- å¤§å°: ${FILE_SIZE} å­—èŠ‚"
        echo "- è¡Œæ•°: ${FILE_LINES} è¡Œ"
        
        # æ·»åŠ æ–‡ä»¶åˆ°Git
        git add "$FILE_PATH"
        
        # åˆ›å»ºæœ‰æ„ä¹‰çš„æäº¤ä¿¡æ¯
        TIMESTAMP=$(date '+%Y-%m-%d %H:%M:%S')
        COMMIT_MESSAGE="ğŸ“º æ›´æ–°ç›´æ’­æºæ–‡ä»¶ - ${TIMESTAMP} UTC"
        COMMIT_MESSAGE+="\n\næ–‡ä»¶ä¿¡æ¯:"
        COMMIT_MESSAGE+="\n- å¤§å°: ${FILE_SIZE} å­—èŠ‚"
        COMMIT_MESSAGE+="\n- è¡Œæ•°: ${FILE_LINES} è¡Œ"
        
        # æäº¤æ›´æ”¹ï¼ˆæ”¯æŒå¤šè¡Œæäº¤ä¿¡æ¯ï¼‰
        echo -e "$COMMIT_MESSAGE" | git commit -F - "$FILE_PATH"
        
        # æ¨é€åˆ°ä»“åº“
        echo "æ¨é€åˆ°GitHubä»“åº“..."
        git push origin HEAD:main
        
        echo "âœ… æäº¤å¹¶æ¨é€å®Œæˆ"
        
    - name: No changes to commit
      if: steps.check-change.outputs.has_change == 'false'
      run: |
        echo "âœ… æ–‡ä»¶æ— å˜åŒ–ï¼Œæ— éœ€æäº¤"
        echo "å½“å‰æ–‡ä»¶ä¿¡æ¯:"
        ls -lh "sej95.github.io/pllive.txt"
        
    - name: Final verification and summary
      run: |
        echo "========================================"
        echo "          ä»»åŠ¡æ‰§è¡Œå®Œæˆæ‘˜è¦"
        echo "========================================"
        
        echo "æ‰§è¡Œæ—¶é—´: $(date '+%Y-%m-%d %H:%M:%S UTC')"
        echo "å¯¹åº”åŒ—äº¬æ—¶é—´: $(date -d '+8 hours' '+%Y-%m-%d %H:%M:%S')"
        
        if [ -f "sej95.github.io/pllive.txt" ]; then
          echo ""
          echo "âœ… æ–‡ä»¶å·²æˆåŠŸä¿å­˜åˆ°ä»“åº“"
          echo "æ–‡ä»¶è·¯å¾„: sej95.github.io/pllive.txt"
          echo "æ–‡ä»¶å¤§å°: $(wc -c < "sej95.github.io/pllive.txt") å­—èŠ‚"
          echo "æ–‡ä»¶è¡Œæ•°: $(wc -l < "sej95.github.io/pllive.txt") è¡Œ"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºM3Uæ ¼å¼
          echo ""
          echo "æ–‡ä»¶æ ¼å¼æ£€æŸ¥:"
          if head -1 "sej95.github.io/pllive.txt" | grep -q "^#EXTM3U"; then
            echo "âœ… æ˜¯æœ‰æ•ˆçš„M3Uæ ¼å¼ç›´æ’­æº"
            CHANNEL_COUNT=$(grep -c "^#EXTINF" "sej95.github.io/pllive.txt" 2>/dev/null || echo "0")
            echo "  åŒ…å«é¢‘é“æ•°: ${CHANNEL_COUNT}"
          else
            echo "âš ï¸ ä¸æ˜¯æ ‡å‡†M3Uæ ¼å¼"
            echo "æ–‡ä»¶å¼€å¤´å†…å®¹:"
            head -3 "sej95.github.io/pllive.txt"
          fi
        else
          echo ""
          echo "âŒ æ–‡ä»¶æœªæ‰¾åˆ°"
        fi
        
        echo ""
        echo "GitçŠ¶æ€:"
        git status --short
        
        echo ""
        echo "ä¸‹æ¬¡è‡ªåŠ¨æ‰§è¡Œæ—¶é—´: UTC 22:00 (åŒ—äº¬æ—¶é—´ 06:00)"
