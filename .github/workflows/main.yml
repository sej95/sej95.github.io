name: Update TV Source File

on:
  schedule:
    - cron: '0 22 * * *'  # UTC 22:00 = Âåó‰∫¨Êó∂Èó¥ 06:00
  workflow_dispatch:

permissions:
  contents: write

jobs:
  update-file:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Setup Git
      run: |
        git config --global user.name "github-actions[bot]"
        git config --global user.email "41898282+github-actions[bot]@users.noreply.github.com"
        
    - name: Prepare directory
      run: |
        mkdir -p tv
        echo "ÂàõÂª∫ tv ÁõÆÂΩï..."
        
    - name: Download TV source file
      id: download
      run: |
        echo "ÂºÄÂßã‰∏ãËΩΩÁõ¥Êí≠Ê∫êÊñá‰ª∂..."
        
        REMOTE_URL="https://my9.ltd/tv/pllive.txt"
        LOCAL_PATH="tv/pllive.txt"
        TEMP_FILE="pllive_temp.txt"
        
        echo "ÁõÆÊ†áURL: $REMOTE_URL"
        
        # ÊñπÊ≥ï1: ÁÆÄÂçïcurl‰∏ãËΩΩ
        echo "=== ÊñπÊ≥ï1: ÁÆÄÂçïcurl‰∏ãËΩΩ ==="
        curl -s -L \
          -o "$TEMP_FILE" \
          -H "User-Agent: curl/8.8.0" \
          -H "Accept: */*" \
          --max-time 60 \
          "$REMOTE_URL"
          
        DOWNLOAD_RESULT=$?
        
        if [ $DOWNLOAD_RESULT -eq 0 ] && [ -f "$TEMP_FILE" ] && [ -s "$TEMP_FILE" ]; then
          FILE_SIZE=$(wc -c < "$TEMP_FILE")
          echo "‚úÖ ÊñπÊ≥ï1‰∏ãËΩΩÊàêÂäü"
          echo "Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
          
          # Ê£ÄÊü•Êñá‰ª∂ÂÜÖÂÆπ
          if head -1 "$TEMP_FILE" | grep -q "MoMoÊõ¥Êñ∞\|#genre#\|#EXTM3U\|‰∏äÊµ∑Áîµ‰ø°"; then
            echo "‚úÖ Êñá‰ª∂ÂÜÖÂÆπÈ™åËØÅÈÄöËøá"
            mv "$TEMP_FILE" "$LOCAL_PATH"
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "method=simple_curl" >> $GITHUB_OUTPUT
          else
            echo "‚ùå Êñá‰ª∂ÂÜÖÂÆπÊó†Êïà"
            rm -f "$TEMP_FILE"
          fi
        else
          echo "‚ùå ÊñπÊ≥ï1Â§±Ë¥•ÔºåÈîôËØØ‰ª£Á†Å: $DOWNLOAD_RESULT"
          rm -f "$TEMP_FILE"
        fi
        
        # ÊñπÊ≥ï2: wget
        if [ ! -f "$LOCAL_PATH" ] || [ ! -s "$LOCAL_PATH" ]; then
          echo ""
          echo "=== ÊñπÊ≥ï2: ‰ΩøÁî®wget‰∏ãËΩΩ ==="
          wget \
            --timeout=45 \
            --tries=3 \
            --user-agent="Mozilla/5.0" \
            --no-check-certificate \
            -O "$LOCAL_PATH" \
            "$REMOTE_URL"
            
          if [ $? -eq 0 ] && [ -s "$LOCAL_PATH" ]; then
            FILE_SIZE=$(wc -c < "$LOCAL_PATH")
            echo "‚úÖ wget‰∏ãËΩΩÊàêÂäü"
            echo "Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "method=wget" >> $GITHUB_OUTPUT
          else
            echo "‚ùå wgetÂ§±Ë¥•"
            rm -f "$LOCAL_PATH"
          fi
        fi
        
        # ÊñπÊ≥ï3: ËØ¶ÁªÜcurl
        if [ ! -f "$LOCAL_PATH" ] || [ ! -s "$LOCAL_PATH" ]; then
          echo ""
          echo "=== ÊñπÊ≥ï3: ËØ¶ÁªÜcurl‰∏ãËΩΩ ==="
          curl -L \
            -o "$LOCAL_PATH" \
            -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36" \
            -H "Accept: text/plain,*/*;q=0.9" \
            -H "Accept-Language: zh-CN,zh;q=0.9" \
            -H "Referer: https://my9.ltd/" \
            --max-time 90 \
            --retry 3 \
            "$REMOTE_URL"
            
          if [ $? -eq 0 ] && [ -s "$LOCAL_PATH" ]; then
            FILE_SIZE=$(wc -c < "$LOCAL_PATH")
            echo "‚úÖ ËØ¶ÁªÜcurl‰∏ãËΩΩÊàêÂäü"
            echo "Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
            echo "downloaded=true" >> $GITHUB_OUTPUT
            echo "method=detailed_curl" >> $GITHUB_OUTPUT
          else
            echo "‚ùå ÊâÄÊúâ‰∏ãËΩΩÊñπÊ≥ïÈÉΩÂ§±Ë¥•"
            
            if [ -f "tv/pllive.txt" ] && [ -s "tv/pllive.txt" ]; then
              echo "‚ö†Ô∏è ‰ΩøÁî®Áé∞ÊúâÊñá‰ª∂"
              echo "downloaded=true" >> $GITHUB_OUTPUT
              echo "method=existing" >> $GITHUB_OUTPUT
            else
              echo "downloaded=false" >> $GITHUB_OUTPUT
              exit 1
            fi
          fi
        fi
        
        # ÊòæÁ§∫ÊúÄÁªà‰ø°ÊÅØ
        if [ -f "$LOCAL_PATH" ] && [ -s "$LOCAL_PATH" ]; then
          FINAL_SIZE=$(wc -c < "$LOCAL_PATH")
          FINAL_LINES=$(wc -l < "$LOCAL_PATH")
          
          echo ""
          echo "=== ‰∏ãËΩΩÂÆåÊàê ==="
          echo "Êñá‰ª∂Â§ßÂ∞è: $FINAL_SIZE Â≠óËäÇ"
          echo "Êñá‰ª∂Ë°åÊï∞: $FINAL_LINES Ë°å"
        fi
        
    - name: Check if file changed
      id: check-change
      if: steps.download.outputs.downloaded == 'true'
      run: |
        echo "Ê£ÄÊü•Êñá‰ª∂ÂèòÂåñ..."
        
        FILE_PATH="tv/pllive.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "‚ùå Êñá‰ª∂‰∏çÂ≠òÂú®"
          echo "has_change=false" >> $GITHUB_OUTPUT
          exit 0
        fi
        
        CURRENT_HASH=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
        echo "ÂΩìÂâçÊñá‰ª∂MD5: $CURRENT_HASH"
        
        if git ls-files "$FILE_PATH" >/dev/null 2>&1; then
          GIT_HASH=$(git hash-object "$FILE_PATH")
          echo "Git‰∏≠Êñá‰ª∂ÂìàÂ∏å: $GIT_HASH"
          
          if [ "$CURRENT_HASH" = "$GIT_HASH" ]; then
            echo "Êñá‰ª∂Êó†ÂèòÂåñ"
            echo "has_change=false" >> $GITHUB_OUTPUT
          else
            echo "Ê£ÄÊµãÂà∞Êñá‰ª∂ÂèòÂåñ"
            echo "has_change=true" >> $GITHUB_OUTPUT
          fi
        else
          echo "Êñá‰ª∂Êú™Ë¢´GitË∑üË∏™ÔºåÊòØÊñ∞Êñá‰ª∂"
          echo "has_change=true" >> $GITHUB_OUTPUT
        fi
        
    - name: Commit and push changes
      if: steps.check-change.outputs.has_change == 'true'
      run: |
        echo "ÂáÜÂ§áÊèê‰∫§Êñá‰ª∂..."
        
        FILE_PATH="tv/pllive.txt"
        
        if [ ! -f "$FILE_PATH" ]; then
          echo "‚ùå Êñá‰ª∂‰∏çÂ≠òÂú®ÔºåÊó†Ê≥ïÊèê‰∫§"
          exit 1
        fi
        
        FILE_SIZE=$(wc -c < "$FILE_PATH")
        FILE_LINES=$(wc -l < "$FILE_PATH")
        FILE_MD5=$(md5sum "$FILE_PATH" | cut -d' ' -f1)
        METHOD="${{ steps.download.outputs.method }}"
        
        echo "Êñá‰ª∂Â§ßÂ∞è: $FILE_SIZE Â≠óËäÇ"
        echo "Êñá‰ª∂Ë°åÊï∞: $FILE_LINES Ë°å"
        echo "Êñá‰ª∂MD5: $FILE_MD5"
        echo "‰∏ãËΩΩÊñπÊ≥ï: $METHOD"
        
        git add "$FILE_PATH"
        
        # ‰ΩøÁî®ÂçïË°åÊèê‰∫§‰ø°ÊÅØ
        COMMIT_MSG="üì∫ Êõ¥Êñ∞Áõ¥Êí≠Ê∫êÊñá‰ª∂ - $(date '+%Y-%m-%d %H:%M UTC') | Â§ßÂ∞è: ${FILE_SIZE}Â≠óËäÇ | Ë°åÊï∞: ${FILE_LINES}Ë°å | ÊñπÊ≥ï: ${METHOD}"
        
        git commit -m "$COMMIT_MSG"
        
        echo "Êé®ÈÄÅÂà∞GitHub..."
        git push
        
        echo "‚úÖ Êèê‰∫§Âπ∂Êé®ÈÄÅÂÆåÊàê"
        
    - name: Show final status
      run: |
        echo "=========================================="
        echo "          ‰ªªÂä°ÊâßË°åÂÆåÊàê"
        echo "=========================================="
        
        echo "ÊâßË°åÊó∂Èó¥: $(date)"
        
        if [ -f "tv/pllive.txt" ]; then
          echo ""
          echo "‚úÖ Êñá‰ª∂Áä∂ÊÄÅ:"
          ls -lh "tv/pllive.txt"
          
          echo ""
          echo "üìä Êñá‰ª∂ÁªüËÆ°:"
          echo "Â§ßÂ∞è: $(wc -c < "tv/pllive.txt") Â≠óËäÇ"
          echo "Ë°åÊï∞: $(wc -l < "tv/pllive.txt") Ë°å"
          
          echo ""
          echo "üìù ÂÜÖÂÆπÈ¢ÑËßà:"
          head -5 "tv/pllive.txt"
          
          echo ""
          echo "üìÅ ÁõÆÂΩïÁªìÊûÑ:"
          find tv -type f
        else
          echo ""
          echo "‚ùå ÈîôËØØ: Êñá‰ª∂Êú™ÊâæÂà∞"
        fi
        
        echo ""
        echo "üìÇ ‰ªìÂ∫ìÁä∂ÊÄÅ:"
        git status --short
        
        echo ""
        echo "‚è∞ ‰∏ãÊ¨°Ëá™Âä®ÊâßË°å: ÊØèÂ§© UTC 22:00 (Âåó‰∫¨Êó∂Èó¥ 06:00)"
